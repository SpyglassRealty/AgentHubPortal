### Add Company Listings Widget to Dashboard - Spyglass Realty Office (5220)

**Feature Request:** Add a "Company Listings" widget to the Dashboard showing Spyglass Realty's active listings from the Austin office (Office Code: 5220).

**Data Source:** Repliers MLS API (ACTRIS)
**Office Code:** 5220 (Spyglass Realty - Austin)
**Office Address:** 2130 Goodrich Ave, Austin, TX 78704
**Future:** Houston office will be added later

---

## PART 1: Dashboard Layout Update

### Current Dashboard Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Good morning, [Name]                                                       â”‚
â”‚  Welcome to Mission Control...                                              â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     Market Pulse            â”‚  â”‚     Action Items            â”‚          â”‚
â”‚  â”‚     (Austin Metro Stats)    â”‚  â”‚                             â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”‚  [Action Items] [Apps] [Resources]                                          â”‚
â”‚                                                                             â”‚
â”‚  Your Applications...                                                       â”‚
â”‚                                                                             â”‚
â”‚  Company Updates...                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### New Dashboard Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Good morning, [Name]                                                       â”‚
â”‚  Welcome to Mission Control...                                              â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                      Market Pulse                              â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
â”‚  â”‚  â”‚   Austin Metro Stats    â”‚  â”‚   Company Listings (5220)   â”‚ â”‚         â”‚
â”‚  â”‚  â”‚   (Bar chart + cards)   â”‚  â”‚   Spyglass Realty Active    â”‚ â”‚         â”‚
â”‚  â”‚  â”‚                         â”‚  â”‚   [Horizontal scroll cards] â”‚ â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚     Action Items            â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                             â”‚
â”‚  [Action Items] [Apps] [Resources]                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## PART 2: API Endpoint for Company Listings (Office-Specific)

### Add to `server/routes.ts`:
```typescript
// GET /api/company-listings/office
// Fetches listings for a specific office (Spyglass Realty)
router.get('/api/company-listings/office', async (req, res) => {
  try {
    const user = req.user;
    if (!user) {
      return res.status(401).json({ error: 'Not authenticated' });
    }

    const officeCode = req.query.officeCode || '5220'; // Spyglass Realty Austin
    const status = req.query.status || 'Active';
    const limit = parseInt(req.query.limit as string) || 20;
    const sortBy = req.query.sortBy || 'listDate';
    const sortOrder = req.query.sortOrder || 'desc';

    if (!REPLIERS_API_KEY) {
      return res.status(500).json({ error: 'Repliers not configured' });
    }

    // Build Repliers API request with ListOfficeKey filter
    const params = new URLSearchParams({
      'OriginatingSystemName': 'ACTRIS',
      'ListOfficeKey': officeCode.toString(),
      'status': status.toString(),
      'limit': limit.toString(),
      'sortBy': sortBy.toString(),
      'sortOrder': sortOrder.toString(),
    });

    const repliersUrl = `${REPLIERS_BASE_URL}/listings?${params}`;
    
    console.log(`[Company Listings Office] Fetching: ${repliersUrl}`);

    const response = await fetch(repliersUrl, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${REPLIERS_API_KEY}`,
        'Content-Type': 'application/json',
      }
    });

    if (!response.ok) {
      console.error('[Company Listings Office] Repliers error:', response.status);
      const errorText = await response.text();
      console.error('[Company Listings Office] Error details:', errorText);
      return res.status(response.status).json({ error: 'Failed to fetch from Repliers' });
    }

    const data = await response.json();

    // Transform to internal schema
    const listings = (data.listings || data.data || []).map((listing: any) => {
      const streetNumber = listing.address?.streetNumber || listing.StreetNumber || '';
      const streetName = listing.address?.streetName || listing.StreetName || '';
      const streetSuffix = listing.address?.streetSuffix || listing.StreetSuffix || '';
      const cityName = listing.address?.city || listing.City || 'Austin';
      const state = listing.address?.state || listing.StateOrProvince || 'TX';
      const postalCode = listing.address?.postalCode || listing.PostalCode || '';
      
      const streetAddress = [streetNumber, streetName, streetSuffix].filter(Boolean).join(' ');
      const fullAddress = `${streetAddress}, ${cityName}, ${state} ${postalCode}`.trim();

      return {
        id: listing.id || listing.listingId,
        mlsNumber: listing.mlsNumber || listing.ListingId,
        status: listing.status || 'Active',
        listPrice: listing.listPrice || listing.ListPrice || 0,
        listDate: listing.listDate || listing.ListDate,
        daysOnMarket: listing.simpleDaysOnMarket || listing.DaysOnMarket || 0,
        address: {
          streetNumber,
          streetName,
          streetSuffix,
          city: cityName,
          state,
          postalCode,
          full: fullAddress,
        },
        beds: listing.beds || listing.BedroomsTotal || 0,
        baths: listing.baths || listing.BathroomsTotalDecimal || 0,
        sqft: listing.livingArea || listing.LivingArea || 0,
        photos: listing.photos || listing.Media?.map((m: any) => m.MediaURL) || [],
        // Agent info if available
        listAgentName: listing.listAgentName || listing.ListAgentFullName,
        listAgentMlsId: listing.listAgentMlsId || listing.ListAgentMlsId,
      };
    });

    console.log(`[Company Listings Office] Fetched ${listings.length} listings for office ${officeCode}`);

    res.json({
      total: data.total || listings.length,
      listings,
      officeCode,
      officeName: 'Spyglass Realty',
      officeAddress: '2130 Goodrich Ave, Austin, TX 78704',
    });
  } catch (error) {
    console.error('[Company Listings Office] Error:', error);
    res.status(500).json({ error: 'Failed to fetch company listings' });
  }
});
```

---

## PART 3: Dashboard Market Pulse Component Update

### Update Dashboard to include Company Listings inside Market Pulse section:
```tsx
// In dashboard.tsx or the Market Pulse component

import React, { useState, useRef } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useNavigate } from 'react-router-dom';
import { 
  TrendingUp, Building2, Home, FileText, Clock, CheckCircle, 
  ChevronLeft, ChevronRight, Bed, Bath, Square, MapPin 
} from 'lucide-react';
import { useTheme } from '@/contexts/ThemeContext';
import { RefreshButton } from '@/components/ui/RefreshButton';

export function MarketPulseWithCompanyListings() {
  const navigate = useNavigate();
  const { isDark } = useTheme();
  const scrollRef = useRef<HTMLDivElement>(null);
  const [selectedListing, setSelectedListing] = useState<any>(null);

  // Fetch market stats
  const { data: statsData, isLoading: statsLoading, refetch: refetchStats } = useQuery({
    queryKey: ['market-pulse-stats'],
    queryFn: async () => {
      const response = await fetch('/api/market-pulse/stats?city=Austin');
      if (!response.ok) throw new Error('Failed to fetch');
      return response.json();
    },
    refetchInterval: 5 * 60 * 1000,
  });

  // Fetch company listings (Spyglass Realty - Office 5220)
  const { data: listingsData, isLoading: listingsLoading, refetch: refetchListings } = useQuery({
    queryKey: ['company-listings-office', '5220'],
    queryFn: async () => {
      const response = await fetch('/api/company-listings/office?officeCode=5220&status=Active&limit=20');
      if (!response.ok) throw new Error('Failed to fetch');
      return response.json();
    },
    refetchInterval: 5 * 60 * 1000,
  });

  const stats = statsData?.stats || {
    active: 0,
    activeUnderContract: 0,
    pending: 0,
    closed: 0,
    totalActive: 0
  };

  const companyListings = listingsData?.listings || [];
  const maxValue = Math.max(stats.active, stats.activeUnderContract, stats.pending, stats.closed, 1);

  // Navigate to Properties page with status filter
  const handleStatusClick = (status: string) => {
    navigate(`/properties?status=${encodeURIComponent(status)}`);
  };

  // Scroll functions
  const scrollLeft = () => scrollRef.current?.scrollBy({ left: -280, behavior: 'smooth' });
  const scrollRight = () => scrollRef.current?.scrollBy({ left: 280, behavior: 'smooth' });

  // Theme classes
  const cardBg = isDark ? 'bg-gray-800' : 'bg-white';
  const textPrimary = isDark ? 'text-white' : 'text-gray-900';
  const textSecondary = isDark ? 'text-gray-400' : 'text-gray-600';
  const borderColor = isDark ? 'border-gray-700' : 'border-gray-200';

  // Status config for bars and cards
  const statusConfig = [
    { key: 'active', resoStatus: 'Active', label: 'Active', sublabel: 'On Market', value: stats.active, color: '#22C55E', textColor: 'text-green-600', bgColor: isDark ? 'bg-green-900/20' : 'bg-green-50', borderColor: 'border-green-200', icon: Home },
    { key: 'activeUnderContract', resoStatus: 'ActiveUnderContract', label: 'Under Contract', sublabel: '', value: stats.activeUnderContract, color: '#3B82F6', textColor: 'text-blue-600', bgColor: isDark ? 'bg-blue-900/20' : 'bg-blue-50', borderColor: 'border-blue-200', icon: FileText },
    { key: 'pending', resoStatus: 'Pending', label: 'Pending', sublabel: 'Closing Soon', value: stats.pending, color: '#EAB308', textColor: 'text-yellow-600', bgColor: isDark ? 'bg-yellow-900/20' : 'bg-yellow-50', borderColor: 'border-yellow-200', icon: Clock },
    { key: 'closed', resoStatus: 'Closed', label: 'Closed (30d)', sublabel: 'Sales', value: stats.closed, color: '#9CA3AF', textColor: 'text-gray-600', bgColor: isDark ? 'bg-gray-800' : 'bg-gray-50', borderColor: 'border-gray-200', icon: CheckCircle },
  ];

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    }).format(price);
  };

  return (
    <div className={`${cardBg} rounded-xl border ${borderColor} p-4 md:p-6`}>
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <TrendingUp className="w-5 h-5 text-[#EF4923]" />
          <h2 className={`text-lg font-semibold ${textPrimary}`}>Market Pulse</h2>
        </div>
        <RefreshButton
          onRefresh={async () => {
            await refetchStats();
            await refetchListings();
          }}
          lastManualRefresh={null}
          lastAutoRefresh={null}
          isLoading={statsLoading || listingsLoading}
        />
      </div>

      {/* Two Column Layout */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        {/* LEFT COLUMN: Austin Metro Stats */}
        <div>
          <p className={`text-sm ${textSecondary} mb-3`}>Austin Metro Area</p>

          {/* Bar Chart */}
          <div className="mb-4">
            <div className="flex">
              <div className="w-8 flex flex-col justify-between text-xs text-gray-400 pr-2">
                <span>{Math.round(maxValue / 1000)}k</span>
                <span>{Math.round(maxValue / 2000)}k</span>
                <span>0</span>
              </div>
              <div className="flex-1 flex items-end gap-2 h-32">
                {statusConfig.map((item) => (
                  <div
                    key={item.key}
                    className="flex-1 flex flex-col items-center cursor-pointer group"
                    onClick={() => handleStatusClick(item.resoStatus)}
                  >
                    <div
                      className="w-full rounded-t transition-all duration-200 group-hover:opacity-80 group-hover:scale-105"
                      style={{
                        height: `${Math.max((item.value / maxValue) * 100, 5)}%`,
                        backgroundColor: item.color,
                        minHeight: '6px'
                      }}
                    />
                    <span className={`mt-1 text-[10px] ${textSecondary} group-hover:text-[#EF4923] transition-colors text-center leading-tight`}>
                      {item.label.replace(' (30d)', '').replace('Under Contract', 'Under\nContract')}
                    </span>
                  </div>
                ))}
              </div>
            </div>
            <p className={`text-xs text-center mt-2 ${textSecondary}`}>
              Click any bar to view listings
            </p>
          </div>

          {/* Stat Cards */}
          <div className="grid grid-cols-2 gap-2">
            {statusConfig.map((item) => {
              const Icon = item.icon;
              return (
                <div
                  key={item.key}
                  onClick={() => handleStatusClick(item.resoStatus)}
                  className={`p-2.5 rounded-lg border cursor-pointer transition-all duration-200
                    hover:shadow-md hover:scale-[1.02] active:scale-[0.98]
                    ${item.bgColor} ${item.borderColor}
                  `}
                >
                  <div className="flex items-center gap-1 mb-0.5">
                    <Icon className={`w-3.5 h-3.5 ${item.textColor}`} />
                    <span className={`text-xs font-medium ${item.textColor}`}>{item.label}</span>
                  </div>
                  {item.sublabel && (
                    <p className={`text-[10px] ${textSecondary}`}>{item.sublabel}</p>
                  )}
                  <p className={`text-lg font-bold ${item.textColor} text-right`}>
                    {item.value.toLocaleString()}
                  </p>
                </div>
              );
            })}
          </div>

          {/* Total */}
          <div className={`mt-3 pt-2 border-t ${borderColor} text-center`}>
            <span className={`text-sm ${textSecondary}`}>Total Active: </span>
            <span className={`font-bold ${textPrimary}`}>{stats.totalActive.toLocaleString()}</span>
          </div>
        </div>

        {/* RIGHT COLUMN: Company Listings */}
        <div>
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <Building2 className="w-4 h-4 text-[#EF4923]" />
              <div>
                <p className={`text-sm font-medium ${textPrimary}`}>Company Listings</p>
                <p className={`text-[10px] ${textSecondary}`}>
                  Spyglass Realty â€¢ {companyListings.length} Active
                </p>
              </div>
            </div>
            <button
              onClick={() => navigate('/properties?officeCode=5220')}
              className={`text-xs text-[#EF4923] hover:underline`}
            >
              View All â†’
            </button>
          </div>

          {/* Loading */}
          {listingsLoading && (
            <div className="flex items-center justify-center py-8">
              <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-[#EF4923]"></div>
            </div>
          )}

          {/* Empty State */}
          {!listingsLoading && companyListings.length === 0 && (
            <div className={`text-center py-6 rounded-lg border-2 border-dashed ${borderColor}`}>
              <Building2 className={`w-8 h-8 mx-auto mb-2 ${textSecondary}`} />
              <p className={`text-sm ${textPrimary}`}>No active listings</p>
              <p className={`text-xs ${textSecondary}`}>Check back later</p>
            </div>
          )}

          {/* Listings Horizontal Scroll */}
          {!listingsLoading && companyListings.length > 0 && (
            <div className="relative">
              {/* Scroll Buttons */}
              {companyListings.length > 2 && (
                <>
                  <button
                    onClick={scrollLeft}
                    className={`absolute left-0 top-1/2 -translate-y-1/2 z-10 p-1.5 rounded-full shadow-lg
                      ${isDark ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-white hover:bg-gray-50 text-gray-700'}
                      hidden sm:flex items-center justify-center`}
                  >
                    <ChevronLeft className="w-4 h-4" />
                  </button>
                  <button
                    onClick={scrollRight}
                    className={`absolute right-0 top-1/2 -translate-y-1/2 z-10 p-1.5 rounded-full shadow-lg
                      ${isDark ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-white hover:bg-gray-50 text-gray-700'}
                      hidden sm:flex items-center justify-center`}
                  >
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </>
              )}

              {/* Cards Container */}
              <div
                ref={scrollRef}
                className="flex gap-3 overflow-x-auto pb-2 scroll-smooth"
                style={{ scrollbarWidth: 'none', msOverflowStyle: 'none', WebkitOverflowScrolling: 'touch' }}
              >
                {companyListings.map((listing: any) => (
                  <CompanyListingCard
                    key={listing.id}
                    listing={listing}
                    isDark={isDark}
                    onClick={() => setSelectedListing(listing)}
                    formatPrice={formatPrice}
                  />
                ))}
              </div>

              {/* Swipe Hint - Mobile Only */}
              <p className={`text-[10px] text-center mt-1 sm:hidden ${textSecondary}`}>
                â† Swipe â†’
              </p>
            </div>
          )}
        </div>
      </div>

      {/* Listing Detail Modal */}
      {selectedListing && (
        <CompanyListingModal
          listing={selectedListing}
          isDark={isDark}
          onClose={() => setSelectedListing(null)}
          formatPrice={formatPrice}
        />
      )}
    </div>
  );
}

// ============================================
// COMPANY LISTING CARD (Compact for Dashboard)
// ============================================

interface CompanyListingCardProps {
  listing: any;
  isDark: boolean;
  onClick: () => void;
  formatPrice: (price: number) => string;
}

function CompanyListingCard({ listing, isDark, onClick, formatPrice }: CompanyListingCardProps) {
  const cardBg = isDark ? 'bg-gray-700' : 'bg-gray-50';
  const textPrimary = isDark ? 'text-white' : 'text-gray-900';
  const textSecondary = isDark ? 'text-gray-400' : 'text-gray-600';
  const borderColor = isDark ? 'border-gray-600' : 'border-gray-200';

  const streetAddress = [
    listing.address?.streetNumber,
    listing.address?.streetName,
    listing.address?.streetSuffix
  ].filter(Boolean).join(' ');

  return (
    <div
      onClick={onClick}
      className={`flex-shrink-0 w-52 ${cardBg} rounded-lg border ${borderColor} overflow-hidden cursor-pointer 
        transition-all duration-200 hover:shadow-md hover:scale-[1.02] active:scale-[0.98]`}
    >
      {/* Photo */}
      <div className="relative aspect-[4/3] bg-gray-300">
        {listing.photos?.[0] ? (
          <img
            src={listing.photos[0]}
            alt={streetAddress}
            className="w-full h-full object-cover"
            loading="lazy"
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center">
            <Building2 className="w-8 h-8 text-gray-400" />
          </div>
        )}
        
        {/* Days on Market Badge */}
        {listing.daysOnMarket > 0 && (
          <span className={`absolute top-1.5 right-1.5 px-1.5 py-0.5 rounded text-[10px] font-medium
            ${isDark ? 'bg-gray-800/80' : 'bg-white/90'} ${textPrimary}`}>
            {listing.daysOnMarket}d
          </span>
        )}

        {/* Photo Count */}
        {listing.photos?.length > 1 && (
          <span className="absolute bottom-1.5 right-1.5 px-1.5 py-0.5 rounded bg-black/60 text-white text-[10px]">
            1/{listing.photos.length}
          </span>
        )}
      </div>

      {/* Info */}
      <div className="p-2">
        <p className={`text-sm font-bold ${textPrimary}`}>
          {formatPrice(listing.listPrice)}
        </p>
        <p className={`text-[11px] ${textPrimary} truncate`}>
          {streetAddress}
        </p>
        <p className={`text-[10px] ${textSecondary} truncate mb-1`}>
          {listing.address?.city}, {listing.address?.state} {listing.address?.postalCode}
        </p>
        <div className="flex items-center gap-2 text-[10px]">
          <span className={`flex items-center gap-0.5 ${textSecondary}`}>
            <Bed className="w-3 h-3" /> {listing.beds}
          </span>
          <span className={`flex items-center gap-0.5 ${textSecondary}`}>
            <Bath className="w-3 h-3" /> {listing.baths}
          </span>
          <span className={`flex items-center gap-0.5 ${textSecondary}`}>
            <Square className="w-3 h-3" /> {listing.sqft?.toLocaleString()}
          </span>
        </div>
      </div>
    </div>
  );
}

// ============================================
// COMPANY LISTING MODAL
// ============================================

function CompanyListingModal({ listing, isDark, onClose, formatPrice }: any) {
  const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);
  
  const modalBg = isDark ? 'bg-gray-900' : 'bg-white';
  const textPrimary = isDark ? 'text-white' : 'text-gray-900';
  const textSecondary = isDark ? 'text-gray-400' : 'text-gray-600';
  const borderColor = isDark ? 'border-gray-700' : 'border-gray-200';

  const photos = listing.photos || [];
  const pricePerSqft = listing.sqft ? Math.round(listing.listPrice / listing.sqft) : null;

  // Prevent body scroll
  React.useEffect(() => {
    document.body.style.overflow = 'hidden';
    return () => { document.body.style.overflow = ''; };
  }, []);

  const streetAddress = [
    listing.address?.streetNumber,
    listing.address?.streetName,
    listing.address?.streetSuffix
  ].filter(Boolean).join(' ');

  return (
    <div 
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4"
      onClick={onClose}
    >
      <div 
        className={`${modalBg} rounded-xl max-w-lg w-full max-h-[85vh] overflow-y-auto`}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className={`sticky top-0 ${modalBg} p-3 border-b ${borderColor} flex items-start justify-between z-10`}>
          <div>
            <h2 className={`text-lg font-bold ${textPrimary}`}>{streetAddress}</h2>
            <p className={`text-xs ${textSecondary}`}>MLS# {listing.mlsNumber}</p>
          </div>
          <button
            onClick={onClose}
            className={`p-2 rounded-full min-w-[44px] min-h-[44px] flex items-center justify-center
              ${isDark ? 'hover:bg-gray-800 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}
          >
            âœ•
          </button>
        </div>

        {/* Photo */}
        <div className="relative bg-black aspect-[16/10]">
          {photos.length > 0 ? (
            <img
              src={photos[currentPhotoIndex]}
              alt={`Photo ${currentPhotoIndex + 1}`}
              className="w-full h-full object-contain"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center bg-gray-800">
              <Building2 className="w-12 h-12 text-gray-600" />
            </div>
          )}
          
          {/* Nav Arrows */}
          {photos.length > 1 && (
            <>
              <button
                onClick={() => setCurrentPhotoIndex((p) => (p - 1 + photos.length) % photos.length)}
                className="absolute left-2 top-1/2 -translate-y-1/2 p-2 rounded-full bg-black/50 text-white"
              >
                <ChevronLeft className="w-5 h-5" />
              </button>
              <button
                onClick={() => setCurrentPhotoIndex((p) => (p + 1) % photos.length)}
                className="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full bg-black/50 text-white"
              >
                <ChevronRight className="w-5 h-5" />
              </button>
              <div className="absolute bottom-3 left-1/2 -translate-x-1/2 px-2 py-1 rounded bg-black/70 text-white text-xs">
                {currentPhotoIndex + 1} / {photos.length}
              </div>
            </>
          )}
        </div>

        {/* Details */}
        <div className="p-4 space-y-3">
          <div className="grid grid-cols-2 gap-3">
            <div>
              <p className={`text-xs ${textSecondary}`}>Price</p>
              <p className={`text-xl font-bold ${textPrimary}`}>{formatPrice(listing.listPrice)}</p>
            </div>
            {pricePerSqft && (
              <div>
                <p className={`text-xs ${textSecondary}`}>Price/SqFt</p>
                <p className={`text-xl font-bold ${textPrimary}`}>${pricePerSqft}</p>
              </div>
            )}
          </div>

          <div className="grid grid-cols-4 gap-2">
            <div>
              <p className={`text-xs ${textSecondary}`}>Beds</p>
              <p className={`text-lg font-bold ${textPrimary}`}>{listing.beds}</p>
            </div>
            <div>
              <p className={`text-xs ${textSecondary}`}>Baths</p>
              <p className={`text-lg font-bold ${textPrimary}`}>{listing.baths}</p>
            </div>
            <div>
              <p className={`text-xs ${textSecondary}`}>SqFt</p>
              <p className={`text-lg font-bold ${textPrimary}`}>{listing.sqft?.toLocaleString()}</p>
            </div>
            <div>
              <p className={`text-xs ${textSecondary}`}>DOM</p>
              <p className={`text-lg font-bold ${textPrimary}`}>{listing.daysOnMarket}</p>
            </div>
          </div>

          <div className={`pt-3 border-t ${borderColor}`}>
            <p className={`text-xs ${textSecondary}`}>Address</p>
            <p className={`font-medium ${textPrimary}`}>{listing.address?.full}</p>
          </div>

          {listing.listAgentName && (
            <div className={`pt-3 border-t ${borderColor}`}>
              <p className={`text-xs ${textSecondary}`}>Listing Agent</p>
              <p className={`font-medium ${textPrimary}`}>{listing.listAgentName}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

---

## PART 4: Update Dashboard Page

### Update `client/src/pages/dashboard.tsx`:

Replace the existing Market Pulse component with the new combined component:
```tsx
import { MarketPulseWithCompanyListings } from '@/components/MarketPulseWithCompanyListings';

// In the dashboard layout, replace Market Pulse section:
<MarketPulseWithCompanyListings />

// Remove the separate Action Items widget from being side-by-side with Market Pulse
// Move Action Items below the Market Pulse section
```

---

## Visual Design Reference

### Dashboard Market Pulse (Two Column)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ Market Pulse                                                     [â†» Refresh]       â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Austin Metro Area                     â”‚  â”‚  ğŸ¢ Company Listings                   â”‚ â”‚
â”‚  â”‚                                        â”‚  â”‚  Spyglass Realty â€¢ 12 Active  View Allâ†’â”‚ â”‚
â”‚  â”‚      â–ˆâ–ˆâ–ˆâ–ˆ                              â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  20k â–ˆâ–ˆâ–ˆâ–ˆ                              â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  15k â–ˆâ–ˆâ–ˆâ–ˆ                              â”‚  â”‚  â”‚PHOTO â”‚  â”‚PHOTO â”‚  â”‚PHOTO â”‚  â”‚PHO   â”‚ â”‚
â”‚  â”‚  10k â–ˆâ–ˆâ–ˆâ–ˆ                              â”‚  â”‚  â”‚      â”‚  â”‚      â”‚  â”‚      â”‚  â”‚      â”‚ â”‚
â”‚  â”‚   5k â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ                â”‚  â”‚  â”‚$525K â”‚  â”‚$699K â”‚  â”‚$450K â”‚  â”‚$1.2M â”‚ â”‚
â”‚  â”‚    0 â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ    â”€â”€â”€â”€        â”‚  â”‚  â”‚123...|  â”‚456...|  â”‚789...|  â”‚321.. â”‚ â”‚
â”‚  â”‚      Active Under  Pend   Closed       â”‚  â”‚  â”‚3/2/1800â”‚ â”‚4/3/2400â”‚ â”‚2/1/1200â”‚ â”‚5/4..â”‚ â”‚
â”‚  â”‚                                        â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  Click any bar to view listings        â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚                                        â”‚  â”‚  â† Swipe â†’ (mobile)                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚                                        â”‚ â”‚
â”‚  â”‚  â”‚ğŸ  Active â”‚ â”‚ğŸ“‹ Under  â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚  â”‚  19,928  â”‚ â”‚Contract  â”‚            â”‚                                             â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  1,935   â”‚            â”‚                                             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                                             â”‚
â”‚  â”‚  â”‚â³ Pendingâ”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                                             â”‚
â”‚  â”‚  â”‚  2,651   â”‚ â”‚âœ“ Closed  â”‚            â”‚                                             â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   275    â”‚            â”‚                                             â”‚
â”‚  â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                                             â”‚
â”‚  â”‚           Total Active: 24,514        â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### Mobile Layout (Stacked)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ Market Pulse        [â†» Refresh] â”‚
â”‚                                     â”‚
â”‚  Austin Metro Area                  â”‚
â”‚  [Bar Chart]                        â”‚
â”‚  [Stat Cards 2x2]                   â”‚
â”‚  Total Active: 24,514               â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                     â”‚
â”‚  ğŸ¢ Company Listings    View All â†’  â”‚
â”‚  Spyglass Realty â€¢ 12 Active        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚PHOTO â”‚  â”‚PHOTO â”‚  â”‚PHOTO â”‚  â†’   â”‚
â”‚  â”‚$525K â”‚  â”‚$699K â”‚  â”‚$450K â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â† Swipe â†’                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## ğŸ“± Mobile Optimization Requirements

**All changes must be optimized for:**

| Device | Browser | Screen Size |
|--------|---------|-------------|
| iPad Pro | Safari | 1024 x 1366 |
| iPad Air/Mini | Safari | 768 x 1024 |
| iPhone 14/15 Pro | Safari | 393 x 852 |
| iPhone SE | Safari | 375 x 667 |
| Android Tablet | Chrome | 800 x 1280 |
| Android Phone | Chrome | 360 x 800 |

### Mobile UX Checklist:
- [ ] Touch targets minimum 44x44px
- [ ] No hover-only interactions (provide touch alternatives)
- [ ] Responsive layouts (stack on mobile, side-by-side on tablet+)
- [ ] Safe area insets for notched devices
- [ ] Smooth scrolling with momentum (-webkit-overflow-scrolling: touch)
- [ ] No horizontal overflow
- [ ] Readable font sizes (min 16px for body text)
- [ ] Fast load times on mobile networks
- [ ] Works in both portrait and landscape orientations

### Responsive Breakpoints:
```css
/* Mobile: < 640px - Stack everything */
/* Tablet: 640px - 1024px - Side-by-side where possible */
/* Desktop: > 1024px - Full two-column layout */

@media (max-width: 1023px) {
  /* Stack Austin Metro and Company Listings */
  .grid-cols-2 { grid-template-columns: 1fr; }
}
```

### Theme Sync:
- [ ] Light mode styling correct
- [ ] Dark mode styling correct
- [ ] System theme detection works
- [ ] Theme toggle updates component immediately

---

## Testing Checklist

### API
- [ ] /api/company-listings/office?officeCode=5220 returns listings
- [ ] Listings include complete address with ZIP
- [ ] Agent name included when available
- [ ] Error handling for missing API key

### Dashboard Layout
- [ ] Market Pulse shows two columns on desktop
- [ ] Stacks to single column on mobile/tablet
- [ ] Company Listings section visible
- [ ] "View All" link navigates to Properties page

### Company Listings Widget
- [ ] Shows Spyglass Realty active listings
- [ ] Displays listing count
- [ ] Horizontal scroll works
- [ ] Cards show photo, price, address, bed/bath/sqft
- [ ] Clicking card opens modal
- [ ] Swipe scroll on mobile

### Listing Modal
- [ ] Opens on card click
- [ ] Photo carousel works
- [ ] All details display
- [ ] Close button works (44x44 touch target)
- [ ] Click outside closes

### Clickable Market Pulse
- [ ] Bars navigate to Properties with status filter
- [ ] Stat cards navigate to Properties with status filter
- [ ] Hover effects on desktop
- [ ] Touch feedback on mobile

### Theme Support
- [ ] Light mode correct
- [ ] Dark mode correct
- [ ] Transitions smooth on toggle